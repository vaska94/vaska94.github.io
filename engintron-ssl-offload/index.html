<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Hugo 0.74.3"><meta name=description content="Linux Blog"><meta name=keywords content="Sysadmin,Linux,Redhat,Centos,Kubernetes"><meta name=author content="Vasil Jamalashvili"><link rel=stylesheet href=https://sysadmin.lol/css/normalize.css><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel=stylesheet type=text/css><link rel=stylesheet href=https://sysadmin.lol/css/cayman.87415a4997c8d6c666624ff26c8812f27f42b4cf5dc18c45fc8dcb0cd7d6d2f5.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><title>Offload HTTPS traffic to Nginx only / Enginitron Cpanel | Sysadmin.lol</title></head><body><section class=page-header><h1 class=project-name>Sysadmin.lol</h1><h2 class=project-tagline>Some random post about linux.</h2><nav><a href=/ class=btn>Blog</a>
<a href=/about/ class=btn>About</a>
<a href=/index.xml class=btn>RSS</a></nav></section><section class=main-content><h1>Offload HTTPS traffic to Nginx only / Enginitron Cpanel</h1><div><strong>Publish date: </strong>2020-06-21</div><p>Hello, Guide which is posted on <a href=https://engintron.com/docs/#/pages/Offload-HTTPS-traffic-to-Nginx-only>engintron.com</a>
is outdated and breaks Force SSL Functionality in Cpanel.
So Here is my Solution:</p><p>Step 1. Edit /etc/apache2/conf.d/includes/pre_virtualhost_global.conf and append:</p><p><code>SetEnvIf X-Forwarded-Proto "https" HTTPS=on</code></p><p>Step 2. Run</p><pre><code>cp /var/cpanel/templates/apache2_4/vhost.default /var/cpanel/templates/apache2_4/vhost.local
sed -i 's/RewriteCond %{HTTPS} !=on/RewriteCond %{HTTP:X-Forwarded-Proto} !https/g' /var/cpanel/templates/apache2_4/vhost.local
/scripts/rebuildhttpdconf
</code></pre><p>Step 3. Edit /etc/nginx/proxy_params_common to update proxy_pass:</p><p><code>proxy_pass http://$PROXY_DOMAIN_OR_IP:8080;</code></p><p>Step 4. restart both apache & nginx</p><p><code>apachectl restart systemctl restart nginx</code></p><p><strong>So what are we actually doing here?</strong></p><ul><li>Step 1, we are defining Apache&rsquo;s behaviour when it sees the &lsquo;X-Forwarded-Proto = https&rsquo; header. With its presence, Apache knows the traffic it is receiving is already secured with HTTPS, so it treats the request like it is https:// accordingly, even though the request is <em>really</em> http:// from nginx.</li><li>Step 2, we are changing default virtualhost template to keep &ldquo;Force SSL&rdquo; Functionality Working and to avoid redirect loops.</li><li>Step 2, we are telling nginx to stop sending traffic to 8443 (Apache&rsquo;s https port) and instead send it to 8080 (Apache&rsquo;s http port).</li><li>Step 4, we are restarting both webservers to apply changes.</li></ul><p><strong>The question is, does it work?</strong>
Yes, it does!</p><p><strong>Any caveats?</strong>
Glad you asked. The only I have come across is with sites using a force-rewrite to https in their .htaccess file. Typically, the code used would be:</p><pre><code>RewriteEngine On
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</code></pre><p>However, since Apache has SSL offloaded and therefore it is not handing HTTPS itself, and this activity is happening directly inside Apache (not PHP, Python, Ruby etc who are already informed about HTTPS), this code will produce a redirect loop. The solution is to use the following .htaccess code instead:</p><pre><code>RewriteCond %{HTTP:X-Forwarded-Proto} !https
RewriteRule .* https://%{SERVER_NAME}%{REQUEST_URI} [R=301,L]
</code></pre><p><strong>One more thing!</strong>
This is slightly unrelated, but sysadmins do note&mldr; when using Engintron&rsquo;s Nginx in front of Apache, we should remove mod_deflate from EasyApache 4. Otherwise, we will waste CPU cycles by GZIPing content twice on the web server (once on Apache, once on nginx) for no reason. This will give a very slight performance boost.</p><p>p.s: you can use grep to find sites using htaccess redirect to avoid redirect loops:
<code>grep -rnHIi '{HTTPS}' --include=.htaccess /home</code></p><p>Author of original guide is : <a href=https://github.com/cloudunboxed-olorinhenderson>@cloudunboxed-olorinhenderson</a></p><p>Author of Revised version : <a href=https://sysadmin.lol>Vasil Jamalashvili</a></p><footer class=site-footer><span class=site-footer-credits>Made with <a href=https://gohugo.io/>Hugo</a>. Themed by <a href=https://github.com/zwbetz-gh/cayman-hugo-theme>Cayman</a>.</span></footer></section><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-177145198-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>