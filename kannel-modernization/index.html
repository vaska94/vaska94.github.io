<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo 0.147.9"><meta name=description content="Linux Blog"><meta name=keywords content="Sysadmin,Linux,Redhat,Centos,Kubernetes"><meta name=author content="Vasil Jamalashvili"><style>html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}</style><link rel=stylesheet href=https://sysadmin.lol/css/cayman.2da5d68c44bb34b0bd616d71c62c99e63a5bb1eb4135be2efd6c4fbe08b29a57.css><link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap' rel=stylesheet type=text/css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><title>Modern Kannel: A No-WAP, Systemd-Ready SMS Gateway | Sysadmin.lol</title></head><body><section class=page-header><h1 class=project-name>Sysadmin.lol</h1><h2 class=project-tagline>Some random post about linux.</h2><nav><a href=/ class=btn>Blog</a>
<a href=/about/ class=btn>About</a>
<a href=/index.xml class=btn>RSS</a></nav></section><section class=main-content><h1>Modern Kannel: A No-WAP, Systemd-Ready SMS Gateway</h1><div><strong>Publish date: </strong>2025-07-05</div><p><strong>Disclaimer:</strong> I have no relation to the Kannel development team or the official Kannel project. This is an independent hobby project based on a Kannel SVN snapshot.</p><h2 id=-source-code>💾 Source Code</h2><p>📦 <a href=https://github.com/vaska94/kannel>GitHub Repository: github.com/vaska94/kannel</a></p><p>Forked from SVN snapshot. Cleaned, modernized, and ready for Rocky Linux 10.</p><hr><p>If you&rsquo;ve worked with SMS gateways in the past decade, you&rsquo;ve likely encountered Kannel. For those unfamiliar, Kannel is an open-source gateway that allows you to send and receive SMS messages via HTTP, SMPP, or other protocols — typically used by telcos, banks, and bulk SMS providers. Originally designed as both a WAP (Wireless Application Protocol) gateway and SMS gateway, Kannel has been a workhorse of mobile messaging infrastructure since the early 2000s. But times have changed, and WAP has gone the way of the dodo. It was time for Kannel to evolve.</p><h2 id=the-problem-legacy-bloat>The Problem: Legacy Bloat</h2><p>Kannel&rsquo;s codebase had accumulated significant technical debt over its 20+ year history. The project still carried extensive WAP functionality that nobody uses anymore - entire directories dedicated to WML scripts, WBMP image handling, and WAP push services. This legacy code wasn&rsquo;t just dead weight; it was actively hampering modern deployments:</p><ul><li>Build complexity with unnecessary dependencies</li><li>Security surface area from unmaintained WAP components</li><li>Confusing configuration options mixing SMS and WAP functionality</li><li>OpenSSL compatibility issues with deprecated certificates</li><li>Outdated initialization systems (init.d scripts from the early 2000s)</li></ul><p>The stable Kannel 1.4.5 release simply won&rsquo;t build on modern distributions like Rocky Linux 10 due to library incompatibilities. Even after fixing the build issues, Kannel 1.4.5 kept crashing when using Redis for DLR storage — which was the tipping point that led to this project. I switched to an SVN snapshot version because it contains many fixes, especially for Redis DLR storage support. The only distro still providing Kannel packages is Debian 12, built with ancient libraries. As a Rocky Linux shop, I wasn&rsquo;t thrilled about running several Debian servers just for SMS gateway functionality.</p><h2 id=the-solution-radical-simplification>The Solution: Radical Simplification</h2><p>Working with Claude AI, I embarked on a modernization journey that would strip Kannel down to its essential purpose: being an excellent SMS gateway. Development was done on Arch Linux (bleeding edge is perfect for catching compatibility issues early), with production deployment targeted at Rocky Linux 10 - a solid enterprise choice for SMS infrastructure. Here&rsquo;s what I accomplished:</p><h3 id=1-complete-wap-removal>1. Complete WAP Removal</h3><p>I performed surgical removal of all WAP-related functionality:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Removed directories:</span>
</span></span><span style=display:flex><span>- wap/           <span style=color:#75715e># WAP gateway implementation</span>
</span></span><span style=display:flex><span>- wmlscript/     <span style=color:#75715e># WML script engine</span>
</span></span><span style=display:flex><span>- radius/        <span style=color:#75715e># RADIUS authentication</span>
</span></span><span style=display:flex><span>- soap/          <span style=color:#75715e># Legacy SOAP/ParlayX support</span>
</span></span><span style=display:flex><span>- debian/        <span style=color:#75715e># Outdated packaging</span>
</span></span><span style=display:flex><span>- solaris/       <span style=color:#75715e># Solaris-specific files (RIP Solaris)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Removed files:</span>
</span></span><span style=display:flex><span>- bb_udp.c       <span style=color:#75715e># WDP/UDP bearer functionality</span>
</span></span><span style=display:flex><span>- seewbmp        <span style=color:#75715e># WBMP image viewer</span>
</span></span><span style=display:flex><span>- pixmapgen.pl   <span style=color:#75715e># WBMP converter</span>
</span></span></code></pre></div><p>This wasn&rsquo;t just a <code>rm -rf</code> operation. I carefully traced through the codebase, removing <code>--disable-wap</code> configure flags, <code>NO_WAP</code> preprocessor blocks, and cleaning up the build system to work without these components.</p><h3 id=2-modern-ssltls-support>2. Modern SSL/TLS Support</h3><p>The old SSL certificates were using 1024-bit RSA with MD5 signatures - completely unacceptable for modern OpenSSL 3.5.0 (especially on Rocky Linux 10 with its strict crypto policies). I replaced them with proper 2048-bit RSA certificates using SHA256:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Added convenient make targets:</span>
</span></span><span style=display:flex><span>make ssl-certs        <span style=color:#75715e># Generate new certificates</span>
</span></span><span style=display:flex><span>make ssl-certs-clean  <span style=color:#75715e># Clean up certificate files</span>
</span></span></code></pre></div><h3 id=3-systemd-integration>3. Systemd Integration</h3><p>Perhaps the most impactful modernization was adding proper systemd service files. No more ancient init.d scripts, or running services as root! The new services include:</p><ul><li><strong>Security hardening</strong>: <code>NoNewPrivileges</code>, <code>ProtectSystem</code>, <code>ProtectHome</code></li><li><strong>Proper dependencies</strong>: smsbox waits for bearerbox</li><li><strong>Resource limits</strong>: Controlled file descriptor limits</li><li><strong>Monitoring integration</strong>: Status script that queries the HTTP admin interface</li></ul><p>Here&rsquo;s a snippet from the bearerbox service file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span><span style=color:#f92672>=</span><span style=color:#e6db74>simple</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span><span style=color:#f92672>=</span><span style=color:#e6db74>kannel</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Group</span><span style=color:#f92672>=</span><span style=color:#e6db74>kannel</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/sbin/bearerbox -v 0 /etc/kannel/kannel.conf</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span><span style=color:#f92672>=</span><span style=color:#e6db74>on-failure</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartSec</span><span style=color:#f92672>=</span><span style=color:#e6db74>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Security hardening</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NoNewPrivileges</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ProtectSystem</span><span style=color:#f92672>=</span><span style=color:#e6db74>strict</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ProtectHome</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ReadWritePaths</span><span style=color:#f92672>=</span><span style=color:#e6db74>/var/log/kannel /var/spool/kannel</span>
</span></span></code></pre></div><h3 id=4-test-infrastructure-fixes>4. Test Infrastructure Fixes</h3><p>The test suite was broken due to:</p><ul><li>Hanging processes from missing cleanup handlers</li><li>Hardcoded relative paths</li><li>SSL PANIC errors from the outdated certificates</li></ul><p>I fixed all of these issues, ensuring tests run cleanly and reliably.</p><h3 id=5-php-script-modernization>5. PHP Script Modernization</h3><p>The kannel-monitor PHP script has been updated to support PHP 8.x, ensuring compatibility with modern PHP deployments.</p><h2 id=the-results>The Results</h2><p>The modernized Kannel is:</p><ul><li><strong>Lighter</strong>: Removed thousands of lines of dead code</li><li><strong>Safer</strong>: Reduced attack surface, modern crypto, proper user isolation</li><li><strong>Easier</strong>: Simplified configuration without WAP options</li><li><strong>Modern</strong>: Systemd integration, OpenSSL 3.x compatibility</li><li><strong>Reliable</strong>: Fixed test suite ensures stability</li></ul><h2 id=getting-started-with-modern-kannel>Getting Started with Modern Kannel</h2><p>Setting up the modernized Kannel is now straightforward:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Clone the modernized version</span>
</span></span><span style=display:flex><span>git clone https://github.com/vaska94/kannel.git
</span></span><span style=display:flex><span>cd kannel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Install dependencies </span>
</span></span><span style=display:flex><span><span style=color:#75715e># For Rocky Linux 10:</span>
</span></span><span style=display:flex><span>sudo dnf install gcc make autoconf automake libtool libxml2-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 openssl-devel pkgconfig mariadb-devel postgresql-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 sqlite-devel hiredis-devel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># For Arch Linux:</span>
</span></span><span style=display:flex><span>sudo pacman -S base-devel autoconf automake libtool libxml2 openssl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>               mariadb-libs postgresql-libs sqlite hiredis
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Bootstrap the build system</span>
</span></span><span style=display:flex><span>autoreconf -fvi -I /usr/share/gettext/m4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Configure with desired options</span>
</span></span><span style=display:flex><span>./configure --enable-ssl --with-ssl<span style=color:#f92672>=</span>/usr --disable-ssl-thread-test <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --with-mysql --with-pgsql --with-sqlite3 --with-redis <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            ac_cv_sys_file_offset_bits<span style=color:#f92672>=</span><span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Build and install</span>
</span></span><span style=display:flex><span>make -j4
</span></span><span style=display:flex><span>sudo make install
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Set up systemd services</span>
</span></span><span style=display:flex><span>sudo ./contrib/systemd/setup-kannel-user.sh
</span></span><span style=display:flex><span>sudo cp contrib/systemd/*.service /etc/systemd/system/
</span></span><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>sudo systemctl enable kannel-bearerbox kannel-smsbox
</span></span></code></pre></div><h2 id=platform-considerations>Platform Considerations</h2><p>Developing on Arch Linux and deploying to Rocky Linux 10 highlighted some interesting platform differences:</p><ul><li><strong>Arch&rsquo;s rolling release</strong> meant I caught OpenSSL 3.5.0 compatibility issues early</li><li><strong>Rocky&rsquo;s SELinux policies</strong> required careful attention to file contexts for the systemd services</li><li><strong>Package naming differences</strong>: <code>libxml2</code> vs <code>libxml2-devel</code>, <code>openssl</code> vs <code>openssl-devel</code></li><li><strong>Crypto policies</strong>: Rocky 10&rsquo;s <code>FUTURE</code> crypto policy immediately rejected the old certificates</li></ul><h2 id=lessons-learned>Lessons Learned</h2><p>This modernization effort taught me several valuable lessons:</p><ol><li><p><strong>Don&rsquo;t be afraid to delete code</strong>: Removing 10,000+ lines of WAP code made the project more maintainable, not less capable.</p></li><li><p><strong>Systemd is a game changer</strong>: The old init.d scripts were so poorly designed that we had almost zero logging visibility. Systemd made everything more convenient - journalctl works beautifully, and I was able to split Kannel into two separate services (bearerbox and smsbox) with proper dependencies.</p></li><li><p><strong>AI-assisted refactoring works</strong>: Claude AI was instrumental in understanding the complex interdependencies and safely removing legacy code. However, I didn&rsquo;t just vibe coding with the AI - I carefully reviewed and tested every change. AI makes mistakes and misses details, but it&rsquo;s incredibly helpful for accelerating development. What would have taken weeks was completed in a single night using Sublime Text, extensive grep searches, and AI assistance.</p></li><li><p><strong>Tests are your safety net</strong>: The comprehensive test suite gave me confidence that SMS functionality remained intact.</p></li></ol><h2 id=production-performance>Production Performance</h2><p>I&rsquo;ve tested this modernized Kannel extensively in production at <a href=https://sender.ge>Sender.ge</a>, and the results speak for themselves:</p><ul><li><strong>5.5K requests per second</strong> on NVMe-based systems</li><li>Rock-solid stability under sustained load</li><li>Zero WAP-related overhead means more resources for SMS processing</li><li><strong>Valkey compatibility</strong>: Running in production with Valkey (Redis fork) instead of Redis with no issues</li></ul><p>Kudos to the original Kannel development team for building such a solid foundation that&rsquo;s still performant after 20+ years!</p><h2 id=whats-next>What&rsquo;s Next?</h2><p>With the WAP baggage gone, our Kannel fork can focus on what it does best: reliable SMS delivery. The immediate challenges ahead:</p><ul><li><strong>Documentation overhaul</strong>: The docs still reference WAP extensively and need modernization</li><li><strong>Benchmark suite</strong>: Getting the existing benchmark suite to run properly (it&rsquo;s there but needs fixing)</li><li><strong>SQLBox investigation</strong>: Haven&rsquo;t touched SQLBox code yet - it should work out of the box, but I&rsquo;ll investigate soon</li><li><strong>CI/CD pipeline</strong>: Create GitHub Actions workflow to automatically build packages</li><li><strong>Package repository</strong>: Build RPM packages for Rocky Linux 10 and set up a proper repository</li><li>Better container support with proper signal handling</li></ul><h2 id=-help-name-this-project>🏷️ Help Name This Project!</h2><p>To avoid confusion with the original Kannel project, I&rsquo;m considering renaming this modernized fork. Current ideas:</p><ul><li><strong>KannelX</strong> - Simple, indicates &ldquo;extended&rdquo; version</li><li><strong>Kannel-Modern</strong> - Clear about purpose</li><li><strong>Your suggestion?</strong></li></ul><p><strong>Got a better name?</strong> Drop your suggestions on X <a href=https://x.com/vaska94>@vaska94</a> - contributions and ideas welcome!</p><hr><p>The code is available at <a href=https://github.com/vaska94/kannel>github.com/vaska94/kannel</a>. If you&rsquo;re running an old Kannel installation, consider upgrading to this streamlined version. Your ops team (and your security auditors) will thank you.</p><hr><h2 id=final-note-on-ai-usage>Final Note on AI Usage</h2><p>Yes, I used AI to help write this article based on my thoughts and experiences. This is NOT an AI-generated article - I provided all the technical information, insights, and experiences, then carefully reviewed everything. I&rsquo;m making the point that AI can have genuinely useful applications beyond creating junk vibe code. When you have the correct understanding of your domain and can carefully review every change to avoid weird modifications, AI becomes a powerful tool for real-world projects.</p><p><em>Have you modernized any legacy systems recently? What challenges did you face? Reach out on X <a href=https://x.com/vaska94>@vaska94</a>.</em></p><footer class=site-footer><span class=site-footer-credits>Made with <a href=https://gohugo.io/>Hugo</a>. Themed by <a href=https://github.com/zwbetz-gh/cayman-hugo-theme>Cayman</a>.</span></footer></section><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-177145198-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>